<!DOCTYPE html>
<html>
<head>
  <title>Вік будинків Станиславова</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="/buildings/style.css" />
  <link rel="stylesheet" href="/buildings/leaflet/leaflet.css" />
  <script src="/buildings/d3.v3.min.js"></script>
  <script src="/buildings/leaflet/leaflet.js"></script>
  <script src="/buildings/leaflet/leaflet.ajax.min.js"></script>
</head>

<body>
  <div class="map" id="map"></div>
  <span id="close" class="close"></span>
  <div id="box">
    <div>
      <div id="info">
        <h2>Info</h2>
        <p>All 9,866,539 <a href="http://www.kadaster.nl/documents/20838/87954/BAG+objectenhandboek+2009+inclusief+besluiten+zorg-+en+studentencomplexen/389eb2fe-1c0f-450e-a56e-cac1b88d4111">buildings</a> in the Netherlands, shaded according to year of construction. Data from <a href="http://www.kadaster.nl/bag">BAG</a> (January 2015), via <a href="http://citysdk.waag.org/">CitySDK LD API</a>. Map made with <a href="http://www.mapbox.com/tilemill/">TileMill</a> by <b><a href="https://twitter.com/bertspaan">Bert Spaan</a>, <a href="http://waag.org/">Waag Society</a></b>, inspired by <a href="http://bklynr.com/block-by-block-brooklyns-past-and-present/">BKLYNR</a>. Map errors can be reported on the <a href="http://www.kadaster.nl/web/Themas/Registraties/BAG/BAGartikelen/BAG-terugmelden.htm">Kadaster's website</a>.</p>
        <p>The source code and TileMill project can be found on <a href="https://github.com/waagsociety/buildings">GitHub</a>. High-res prints are available in <a href="http://waagsociety.werkaandemuur.nl/">our web shop</a>.</p>
      </div>
      <div id="legend">
        <h2>Legend</h2>
        <table>
          <tr><td class="key color1"></td><td class="value first">&lt; 1800</td>   <td class="key color7"></td><td class="value">1960 - 1975</td></tr>
          <tr><td class="key color2"></td><td class="value first">1800 - 1850</td> <td class="key color8"></td><td class="value">1975 - 1985</td></tr>
          <tr><td class="key color3"></td><td class="value first">1850 - 1900</td> <td class="key color9"></td><td class="value">1985 - 1995</td></tr>
          <tr><td class="key color4"></td><td class="value first">1900 - 1930</td> <td class="key color10"></td><td class="value">1995 - 2005</td></tr>
          <tr><td class="key color5"></td><td class="value first">1930 - 1945</td> <td class="key color11"></td><td class="value">&gt; 2005</td></tr>
          <tr><td class="key color6"></td><td class="value first">1945 - 1960</td> <td></td><td></td></tr>
        </table>
      </div>
      
      <div id="waag">
        <a href="#48.923,24.7119,16"><img src="/buildings/images/waag.png" /></a>
      </div>
    </div>
  <div>

  <script>

    var baseAddress = "http://map.klym.uk/"

    var disableHashChange = false;
    var map = L.map('map');
    var tileUrl = baseAddress + "buildings/tiles/{z}/{x}/{y}.png";

    function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
          stroke: true
        });
    }

    function resetHighlight(e) {
        var layer = e.target;
        layer.setStyle({
          stroke: false
        });
    }

    function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: zoomToFeature
        });

        var out = [];
        if (feature.properties){
        for(key in feature.properties){
            out.push(key+": "+feature.properties[key]);
        }
        layer.bindPopup(out.join("<br />"));
      }
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

     var geojsonLayer = new L.geoJson.ajax(baseAddress + "buildings/tiles/buildings.geojson", {
      onEachFeature:onEachFeature,
      style: {
             stroke: false,
             fillOpacity: 0,
             weight: 2
          }
    });

    geojsonLayer.addTo(map);

    var tileLayer = L.tileLayer(tileUrl, {
      attributionControl: false,
      minZoom: 15,
      maxZoom: 19
    });

    tileLayer.addTo(map);

    map.setMaxBounds([
      [48.9313,24.7254],
      [48.9078,24.6889]
    ]);

    map.setView([48.9228, 24.7103], 16);

    map.on('moveend', function(e) {
      var lat = roundLatLon(map.getCenter().lat);
      var lon = roundLatLon(map.getCenter().lng);
      var zoom = map.getZoom();

      disableHashChange = true;
      window.location.hash = [lat, lon, zoom].join(",");
    });

    map.on('click', function(e) {
      var lat = e.latlng.lat,
          lon = e.latlng.lng;
    });

    d3.select("#close").on("click", function() {
      var closed = d3.select(this).classed("closed");

      d3.select("#box")
          .classed("hidden", closed)
          .transition()
          .duration(150)
          .style("opacity", closed ? 1 : 0)
          .each("end", function() { d3.select(this).classed("hidden", !closed); });

      d3.select(this).classed("closed", !closed);
    });

    window.onhashchange = function() {
      if (!disableHashChange) {
        var hash = window.location.hash.split(",");;
        if (hash.length == 3) {
          var lat = parseFloat(hash[0].substring(1)), // Remove "#"
              lon = parseFloat(hash[1]),
              zoom = parseInt(hash[2]);

          map.setView([lat, lon], zoom);
        }
      }
      disableHashChange = false;
    }

    window.onhashchange();

    function roundLatLon(l) {
      return Math.round(l * 10000) / 10000;
    }

    function formatNumber(x) {
      x = x.toString();
      var pattern = /(-?\d+)(\d{3})/;
      while (pattern.test(x))
        x = x.replace(pattern, "$1,$2");
      return x;
    }

  </script>
</body>
</html>
